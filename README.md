# AWS EKS Cloud

- [AWS EKS Cloud](#aws-eks-cloud)
  - [Resources that are created](#resources-that-are-created)
  - [Setup](#setup)
    - [Kubernetes Client](#kubernetes-client)
    - [AWS Setup](#aws-setup)
    - [AWS Credentials](#aws-credentials)
    - [Terraform State files](#terraform-state-files)
    - [Environment Variables](#environment-variables)
    - [CDKTF Setup](#cdktf-setup)


CDKTF (Cloud Development Kit - Terraform) scripts creates EKS infrastructure in the AWS account

## Resources that are created

- 2 public subnets
- 1 Service role for EKS cluster
- 1 EKS node role
- 1 EKS worker node policy
- 1 EC2 container registry policy
- 1 EKS CNI policy
- 1 CSI Driver policy
- 2 node EKS cluster

## Setup

### Kubernetes Client

Follow the instructions outlined here <https://kubernetes.io/docs/tasks/tools/>

### AWS Setup

Take a look at the following documentation for more information: 

<https://github.com/ggrover/gauravgrover-docs#aws-setup-and-configuration>

### AWS Credentials

Take a look at the following documentation for more information: 

<https://github.com/ggrover/gauravgrover-docs#authentication>

Also take a look at this information:

See [here](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
for all the ways to provide AWS credentials.

### Terraform State files

The state files are sent to S3 via CDKTS's S3 Backend. It is set to the following bucket
`cdktf-backend-k8s` . It was created via the AWS console

### Environment Variables

| name        | description                                                                                  | default   |
|-------------|----------------------------------------------------------------------------------------------|-----------|
| NODE_CONFIG | can be `development`, `staging`, `production`, will set the config for the given environment | undefined |

Ref: <https://www.npmjs.com/package/config>

### CDKTF Setup 

- Install nodejs framework - <https://docs.npmjs.com/downloading-and-installing-node-js-and-npm>
- Install the node modules
  ```sh
  npm install //installs node modules in the package.json. Also installs cdktf locally in your workspace 
  ```
- Generate typescript constructs used in the source. A `.gen` directory will be generated
```sh
cdktf get

Generated typescript constructs in the output directory: .gen
```

- Authenticate with AWS by running the following script located: <https://github.com/ggrover/gauravgrover-k8s-cdktf-demo/blob/task/demo/auth.sh> ` . ./auth.sh && sso aws-personal `
- Run `cdktf synth` Synthesizes Terraform code (Similar to terraform plan). This generates a `cdktf.out` directory.
  Under `cdktf.out/stacks/` there will be a file called `cdk.tf.json` which is identical to the file generated by terraform plan or apply. You can in fact run all terraform commands from here as well. Example

  ```sh
  {
  "//": {
    "metadata": {
      "version": "0.8.3",
      "stackName": "eks-aws-1",
      "backend": "s3"
    }
  },
  "terraform": {
    "required_providers": {
      "aws": {
        "version": "~> 4.0",
        "source": "hashicorp/aws"
      },
      "tls": {
        "version": "~> 3.1",
        "source": "hashicorp/tls"
      }
    },
  ```
- To deploy the infrastructure into AWS EKS run the following `cdktf deploy`. Accept the terraform plan presented, and then wait for about 10 mins for the infrastructure to become available. You can monitor the creation of the resources by heading to the AWS console
  

```sh
+ AWS_SUBNET           demo-public-1       aws_subnet.demo-public-1
 + AWS_SUBNET           demo-public-2       aws_subnet.demo-public-2
 ~ DATA                 tls_certificate     data.tls_certificate.demo-cluster_tls_F
                                            A58E6A9

Diff: 12 to create, 0 to update, 0 to delete.

Do you want to perform these actions?
 CDK for Terraform will perform the actions described above.
 Only 'yes' will be accepted to approve.
```

- When all resources have been created you should see something similar to this

```sh
✔ AWS_SUBNET           demo-public-1       aws_subnet.demo-public-1
 ✔ AWS_SUBNET           demo-public-2       aws_subnet.demo-public-2
 ~ DATA                 tls_certificate     data.tls_certificate.demo-cluster_tls_F
                                            A58E6A9
Summary: 12 created, 0 updated, 0 destroyed.

Output: publicSubnet1 = subnet-0e6f1aa8958b1d095
        publicSubnet2 = subnet-05a2e30f44be5ee5a196.99s user 6.55s system 22% cpu 14:51.56s total
```

- Go can also verify that the terraform remote state has been added to the AWS s3 bucket
  ![ S3 Bucket ](./images/Screen%20Shot%202023-02-05%20at%201.15.12%20PM.png)
- Set the kubernetes context by running the following command `. ./auth.sh && eks aws-personal` (make sure that you add you aws profile) <https://github.com/ggrover/gauravgrover-k8s-cdktf-demo/blob/task/demo/auth.sh>  

```sh
Updated context arn:aws:eks:us-west-2:233872589811:cluster/k8s-cluster in /Users/ggrover/.kube/config
```

- Verify kubernetes nodes

```sh
kubectl get nodes                                                                                                                                                                   ✔  k8s-cluster ⎈ 
NAME                                          STATUS   ROLES    AGE     VERSION
ip-172-31-54-255.us-west-2.compute.internal   Ready    <none>   7m38s   v1.24.9-eks-49d8fe8
```

- To delete resources run the following command `cdktf destory`